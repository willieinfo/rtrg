<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTRG Weekly Reports</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="chart.css">
    <style>
        /* Hide the content initially */
        body {
            visibility: hidden;
        }
    </style>
    <script>
        window.onload = function() {
            // Check if the user is logged in
            if (sessionStorage.getItem('loggedIn') !== 'true') {
                window.location.href = 'login.html'; // Redirect to login page if not logged in
            } else {
                document.body.style.visibility = 'visible';
            }
        };

        function logout() {
            sessionStorage.removeItem('loggedIn'); // Clear login state
            window.location.href = 'login.html'; // Redirect to login page
           
        }
    </script>
</head>
<body>
    <!-- <button onclick="logout()">Logout</button> -->
    <div id="mySidenav" class="sidenav">
        <div class="image-wrapper">
            <img src="./Graphics/RTRG.jpg" alt="RTRG">
        </div>
        <hr>
        <a href="#weeklyChart" onclick="toggleNav()">Weekly</a>
        <a href="#dailyChart" onclick="toggleNav()">Daily</a>
        <a style="pointer-events: none" href="#dailyChart" onclick="toggleNav()">Hourly</a>
        <a href="#brandChart" onclick="toggleNav()">Brand</a>
        <hr>
        <a href="pdfReports.html" onclick="toggleNav()">PDF Reports</a>
        <hr>
        <a href="#logout" onclick="logout()">Log Out</a>
        
 A   </div>

    <div id="main">
        <div class="dataFilter">
            <button class="openbtn" onclick="toggleNav()">☰ Open</button>
            <div class="centered">
                <select id="storeGroup" name="StorGrup" style="margin-right: 10px;"></select>
                <select id="storeNames" name="StorName" style="margin-right: 10px;"></select>
                <button 
                    id='btnRefresh' 
                    ><i class="material-icons w3-spin">refresh</i>
                    Refresh Charts</button>

            </div>
        </div>
        <div id="weeklyChart" class="chart-container weeklyChart">
            <canvas id="myChart2"></canvas>
            <details>
                <summary>Last 6 weeks</summary>
                <ul>
                    <li>
                        Tracks weekly sales performance over the last 6 weeks, illustrating trends of 3 different years using the same period.
                    </li>
                    <li>
                        Visualizes fluctuations in weekly sales, providing insight into patterns and performance 
                        consistency.
                    </li>
                </ul>
            </details>
        </div>
        
        <div id="dailyChart" class="chart-container dailyChart">
            <canvas id="myChart1"></canvas>
            <details>
                <summary>Last 31 days</summary>
                <ul>
                    <li>
                        Displays daily sales performance for the past 31 days, emphasizing sales trends on Sundays.
                    </li>
                    <li>
                        Highlights daily sales with a focus on Sunday or weekend performance, showing fluctuations and peak 
                        periods.
                    </li>
                </ul>
            </details>
        </div>
        
        <div id="brandChart" class="chart-container brandChart">
            <h5>Top 30 Brands</h5>
            <div class="barChartContainer">
                <div class='barChart1'>
                    <canvas id="myChart3"></canvas>
                </div>
                <div class='barChart1'>
                    <canvas id="myChart4"></canvas>
                </div>
            </div>
            <details>
                <summary>Top 30 brands</summary>
                <ul>
                    <li>
                        Compares the top 30 brands' performance between the current and previous years covering the scoped period of the report.
                    </li>
                    <li>
                        Visualizes overall top 30 brands and brand performances per store.         
                    </li>
                </ul>
            </details>
        </div>
        <footer>
            <div class="imageWrapper">
                <img src="./Graphics/InfoPlus.png" alt="InfoPlus">
            </div>
            <div>
                <p>Regent Travel Retail Group</p>
            </div>
        </footer>
    </div>

    <script>
        function toggleNav() {
            const sidenav = document.getElementById("mySidenav");
            const main = document.getElementById("main");
            const openbtn = document.querySelector(".openbtn");

            if (sidenav.style.width === "200px") {
                sidenav.style.width = "0";
                main.style.marginLeft = "0";
                openbtn.textContent = "☰ Open";
                openbtn.classList.remove("open");
                sidenav.style.padding= '0px'; 

            } else {
                sidenav.style.width = "200px";
                main.style.marginLeft = "200px";
                openbtn.textContent = "X Close";
                openbtn.classList.add("open");
                sidenav.style.padding= '20px'; 
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="dailyChart.js"></script>
    <script src="weeklyChart.js"></script>
    <script src="brandChart.js"></script>

    <script>
        // Global variables
        let chartData = [];
        let myChart1 = null;
        let myChart2 = null;
        let myChart3 = null;
        let myChart4 = null;
        const dataSource1='./Data/DB_DAILYSALES.json'
        //const dataSource1='./Data/DB_DAILYSALES3.json'


        // Function to fetch JSON data
        async function fetchData() {
            try {
                const salesResponse = await fetch(dataSource1);
                if (!salesResponse.ok) throw new Error('Network response was not ok');
                chartData = await salesResponse.json();
                
                await populateStoreSelect(); // Populate store select list after fetching data
                setDailyChart(); // Initialize the daily chart
                setWeeklyChart(); // Initialize the weekly chart
                fetchBrandSales();
                document.getElementById("btnRefresh").disabled = true;
                updateButtonState()

            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        // Function to populate the store select list
        let storeData = {}; // Object to store store names by business group

        // Function to populate the store select list
        async function populateStoreSelect() {
            try {
                const storeResponse = await fetch('./Data/DB_STORNAME.json');
                if (!storeResponse.ok) throw new Error('Network response was not ok');
                const optionData = await storeResponse.json();

                const listGrup = document.getElementById('storeGroup');
                // Create and insert a All Group option as the first item
                const allGrupOption = document.createElement('option');
                allGrupOption.value = ''; // No value for the first option
                allGrupOption.textContent = 'All Business Group'; // Text for the first option
                listGrup.appendChild(allGrupOption);

                const listStor = document.getElementById('storeNames');
                // Create and insert a All Store option as the first item
                const allStorOption = document.createElement('option');
                allStorOption.value = ''; // No value for the first option
                allStorOption.textContent = 'All Stores'; // Text for the first option
                listStor.appendChild(allStorOption);

                // Create a Set to track unique store names and business group
                const seenGroupNames = new Set();
                const seenStoreNames = new Set();

                storeData = {}; // Reset the data structure

                optionData.forEach(data => {
                    // Populate Business Groups
                    if (!seenGroupNames.has(data.storegrp)) {
                        seenGroupNames.add(data.storegrp);

                        const option1 = document.createElement('option');
                        option1.value = data.storegrp;
                        option1.textContent = data.storegrp;
                        listGrup.appendChild(option1);
                    }

                    // Populate Store Names
                    if (!seenStoreNames.has(data.storname)) {
                        seenStoreNames.add(data.storname);

                        if (!storeData[data.storegrp]) {
                            storeData[data.storegrp] = [];
                        }
                        storeData[data.storegrp].push(data.storname);
                    }
                });

                // Event listener for storeGroup change
                listGrup.addEventListener('change', () => {
                    const selectedGroup = listGrup.value;
                    updateStoreNames(selectedGroup);
                    document.getElementById("btnRefresh").disabled = false;
                    updateButtonState()
                });

                // Initial load for storeNames based on the default value
                updateStoreNames(listGrup.value);

                // Event listener for storeGroup change
                listStor.addEventListener('change', () => {
                    document.getElementById("btnRefresh").disabled = false;
                    updateButtonState()
                });

            } catch (error) {
                console.error('Error fetching store names:', error);
            }
        }

        // Function to update the class based on the button's state
        function updateButtonState() {
            var button = document.getElementById("btnRefresh");
            var icon = button.querySelector("i.material-icons");
            
            if (button.disabled) {
                // Remove 'w3-spin' class when disabled
                icon.classList.remove("w3-spin");
                button.style="color: #111";
                button.style="background-color: rgb(128,128,128)" ;

            } else {
                // Add 'w3-spin' class when enabled
                icon.classList.add("w3-spin");
                button.style="color: #f1f1f1";
                button.style="background-color: rgb(53,154,255)" ;
            }
        }

        // Function to update storeNames based on selected storeGroup
        function updateStoreNames(group) {
            const listStor = document.getElementById('storeNames');
            
            // Clear existing options
            listStor.innerHTML = '';
            
            // Create and insert a All Store option as the first item
            const allStorOption = document.createElement('option');
            allStorOption.value = ''; // No value for the first option
            allStorOption.textContent = 'All Stores'; // Text for the first option
            listStor.appendChild(allStorOption);

            if (group === '') {
                // Show all stores if no group is selected
                Object.values(storeData).flat().forEach(storeName => {
                    const option = document.createElement('option');
                    option.value = storeName;
                    option.textContent = storeName;
                    listStor.appendChild(option);
                });
            } else {
                // Show stores for the selected group
                if (storeData[group]) {
                    storeData[group].forEach(storeName => {
                        const option = document.createElement('option');
                        option.value = storeName;
                        option.textContent = storeName;
                        listStor.appendChild(option);
                    });
                }
            }
        }


        document.getElementById('btnRefresh')
            .addEventListener('click', ()=>{
                const listStor = document.getElementById('storeNames')
                const listGrup = document.getElementById('storeGroup')
                const cStorName = listStor.value;
                const cStorGrup = listGrup.value;
                setDailyChart(cStorName,cStorGrup);
                setWeeklyChart(cStorName,cStorGrup);
                fetchBrandSales(cStorName,cStorGrup);
                document.getElementById("btnRefresh").disabled = true;
                updateButtonState()
            })

        fetchData();
    </script>
</body>
</html>
